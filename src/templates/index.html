<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Property Price Projection</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<link
			rel="stylesheet"
			href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		/>
		<link
			rel="stylesheet"
			href="https://unpkg.com/leaflet-geosearch@3.11.0/dist/geosearch.css"
		/>
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
			rel="stylesheet"
		/>
		<style>
			:root {
				--primary-color: #2563eb;
				--secondary-color: #64748b;
				--success-color: #10b981;
				--background-color: #f8fafc;
				--card-bg: #ffffff;
				--border-color: #e2e8f0;
				--shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
				--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
			}

			* {
				box-sizing: border-box;
			}

			body {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				margin: 0;
				padding: 0;
				min-height: 100vh;
			}

			.main-container {
				background: var(--background-color);
				min-height: 100vh;
				padding: 1rem;
			}

			.dashboard-header {
				background: var(--card-bg);
				border-radius: 1rem;
				padding: 1.5rem;
				margin-bottom: 1.5rem;
				box-shadow: var(--shadow);
				text-align: center;
			}

			.dashboard-header h1 {
				color: var(--primary-color);
				font-weight: 700;
				margin: 0;
				font-size: clamp(1.5rem, 4vw, 2.5rem);
			}

			.dashboard-header p {
				color: var(--secondary-color);
				margin: 0.5rem 0 0 0;
				font-size: clamp(0.9rem, 2vw, 1.1rem);
			}

			.dashboard-grid {
				display: grid;
				gap: 1.5rem;
				grid-template-columns: 1fr;
				grid-template-areas: 
					"controls"
					"map"
					"chart";
			}

			/* Desktop Layout */
			@media (min-width: 992px) {
				.dashboard-grid {
					grid-template-columns: 350px 1fr;
					grid-template-areas: 
						"controls map"
						"chart chart";
				}
			}

			/* Large Desktop Layout */
			@media (min-width: 1400px) {
				.dashboard-grid {
					grid-template-columns: 380px 1fr 1fr;
					grid-template-areas: 
						"controls map chart";
				}
			}

			.controls-panel {
				grid-area: controls;
				background: var(--card-bg);
				border-radius: 1rem;
				padding: 1.5rem;
				box-shadow: var(--shadow);
				height: fit-content;
			}

			.map-container {
				grid-area: map;
				background: var(--card-bg);
				border-radius: 1rem;
				padding: 1.25rem;
				box-shadow: var(--shadow);
			}

			.chart-container {
				grid-area: chart;
				background: var(--card-bg);
				border-radius: 1rem;
				padding: 1.5rem;
				box-shadow: var(--shadow);
				min-height: 400px;
				display: flex;
				flex-direction: column;
			}

			.controls-header {
				display: flex;
				align-items: center;
				margin-bottom: 1.25rem;
				color: var(--primary-color);
			}

			.controls-header i {
				margin-right: 0.75rem;
				font-size: 1.2rem;
			}

			.controls-header h5 {
				margin: 0;
				font-weight: 600;
				font-size: clamp(1rem, 2vw, 1.25rem);
			}

			.form-group {
				margin-bottom: 1.25rem;
			}

			.form-label {
				font-weight: 600;
				color: var(--secondary-color);
				margin-bottom: 0.5rem;
				display: block;
				font-size: 0.9rem;
			}

			.form-control {
				border: 2px solid var(--border-color);
				border-radius: 0.5rem;
				padding: 0.75rem;
				transition: all 0.3s ease;
				width: 100%;
				font-size: 1rem;
			}

			.form-control:focus {
				border-color: var(--primary-color);
				box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
				outline: none;
			}

			.btn-primary {
				background: var(--primary-color);
				border: none;
				border-radius: 0.5rem;
				padding: 0.75rem 1.5rem;
				font-weight: 600;
				transition: all 0.3s ease;
				width: 100%;
				margin-bottom: 0.75rem;
				font-size: 1rem;
				color: white;
			}

			.btn-primary:hover {
				background: #1d4ed8;
				transform: translateY(-1px);
				box-shadow: var(--shadow-lg);
			}

			.btn-outline-secondary {
				border: 2px solid var(--border-color);
				border-radius: 0.5rem;
				padding: 0.75rem 1.5rem;
				color: var(--secondary-color);
				font-weight: 600;
				transition: all 0.3s ease;
				width: 100%;
				background: transparent;
				font-size: 1rem;
			}

			.btn-outline-secondary:hover {
				background: var(--secondary-color);
				border-color: var(--secondary-color);
				color: white;
				transform: translateY(-1px);
			}

			.chart-header {
				display: flex;
				justify-content: space-between;
				align-items: flex-start;
				margin-bottom: 1.25rem;
				flex-wrap: wrap;
				gap: 1rem;
			}

			.chart-title {
				display: flex;
				align-items: center;
				color: var(--primary-color);
				flex: 1;
				min-width: 200px;
			}

			.chart-title i {
				margin-right: 0.75rem;
				font-size: 1.2rem;
			}

			.chart-title h5 {
				margin: 0;
				font-weight: 600;
				font-size: clamp(1rem, 2vw, 1.25rem);
			}

			.chart-actions {
				display: flex;
				gap: 0.75rem;
				flex-wrap: wrap;
			}

			.chart-actions .btn {
				border-radius: 0.5rem;
				padding: 0.5rem 1rem;
				font-size: 0.85rem;
				display: flex;
				align-items: center;
				gap: 0.5rem;
				white-space: nowrap;
				min-width: 80px; /* Fixed minimum width */
				justify-content: center; /* Center content */
			}

			/* Make both export buttons the same size */
			.chart-actions .btn-outline-secondary,
			.chart-actions .btn-outline-success {
				width: 80px;
				padding: 0.5rem 0.75rem;
			}

			.chart-content {
				flex: 1;
				display: flex;
				align-items: center;
				justify-content: center;
				min-height: 300px;
				position: relative;
			}

			.chart-content canvas {
				max-width: 100%;
				height: auto !important;
			}

			.map-header {
				display: flex;
				align-items: center;
				margin-bottom: 1rem;
				color: var(--primary-color);
			}

			.map-header i {
				margin-right: 0.75rem;
				font-size: 1.2rem;
			}

			.map-header h5 {
				margin: 0;
				font-weight: 600;
				font-size: clamp(1rem, 2vw, 1.25rem);
			}

			#map {
				height: 300px;
				width: 100%;
				border-radius: 0.75rem;
				border: 2px solid var(--border-color);
			}

			@media (min-width: 768px) {
				#map {
					height: 350px;
				}
			}

			@media (min-width: 1400px) {
				#map {
					height: 400px;
				}
			}

			.metro-info {
				background: linear-gradient(135deg, var(--success-color), #059669);
				color: white;
				padding: 0.75rem 1rem;
				border-radius: 0.5rem;
				margin-top: 1rem;
				display: flex;
				align-items: center;
				font-size: 0.9rem;
			}

			.metro-info i {
				margin-right: 0.75rem;
				font-size: 1rem;
			}

			.empty-state {
				text-align: center;
				color: var(--secondary-color);
				padding: 3rem 1rem;
			}

			.empty-state i {
				font-size: clamp(2.5rem, 8vw, 4rem);
				margin-bottom: 1.25rem;
				opacity: 0.5;
			}

			.empty-state h5 {
				margin-bottom: 0.75rem;
				font-size: clamp(1rem, 3vw, 1.25rem);
			}

			.empty-state p {
				font-size: clamp(0.85rem, 2vw, 1rem);
			}

			.alert-danger {
				border-radius: 0.75rem;
				border: none;
				background: #fef2f2;
				color: #dc2626;
				padding: 1rem;
				margin: 1rem 0;
			}

			/* Mobile Optimizations */
			@media (max-width: 576px) {
				.main-container {
					padding: 0.75rem;
				}

				.dashboard-header {
					padding: 1rem;
					margin-bottom: 1rem;
				}

				.controls-panel,
				.chart-container,
				.map-container {
					padding: 1rem;
				}

				.dashboard-grid {
					gap: 1rem;
				}

				.chart-header {
					flex-direction: column;
					align-items: stretch;
				}

				.chart-actions {
					justify-content: center;
				}

				.chart-actions .btn-outline-secondary,
				.chart-actions .btn-outline-success {
					width: 90px;
				}

				.form-control,
				.btn-primary,
				.btn-outline-secondary {
					padding: 1rem;
					font-size: 1.1rem;
				}
			}

			/* Leaflet customizations */
			.leaflet-tooltip-pane .leaflet-tooltip {
				background: rgba(37, 99, 235, 0.9);
				border: none;
				border-radius: 0.5rem;
				color: white;
				font-weight: 600;
				box-shadow: var(--shadow);
				font-size: 0.8rem;
			}

			.leaflet-control-geosearch {
				border-radius: 0.5rem;
			}

			.leaflet-control-geosearch .glass {
				border-radius: 0.5rem;
			}

			/* Ensure proper button styling */
			button {
				cursor: pointer;
			}

			button:disabled {
				opacity: 0.6;
				cursor: not-allowed;
			}
		</style>
	</head>
	<body>
		<div class="main-container">
			<!-- Dashboard Header -->
			<div class="dashboard-header">
				<h1><i class="fas fa-chart-line"></i> Property Price Projection</h1>
				<p>AI-powered real estate price forecasting for Dubai</p>
			</div>

			<!-- Main Dashboard Grid -->
			<div class="dashboard-grid">
				<!-- Controls Panel (Input First) -->
				<div class="controls-panel">
					<div class="controls-header">
						<i class="fas fa-cog"></i>
						<h5>Property Details</h5>
					</div>

					<form id="projection-form" method="POST" action="/">
						<div class="form-group">
							<label for="rooms" class="form-label">
								<i class="fas fa-bed"></i> Number of Rooms
							</label>
							<input
								type="number"
								class="form-control"
								name="rooms"
								min="1"
								value="{{ form_data.get('rooms', 1) }}"
								required
							/>
						</div>

						<!-- Hidden Coordinates -->
						<input
							type="hidden"
							id="latitude"
							name="latitude"
							value="{{ form_data.get('latitude', 25.2048) }}"
						/>
						<input
							type="hidden"
							id="longitude"
							name="longitude"
							value="{{ form_data.get('longitude', 55.2708) }}"
						/>

						<div class="form-group">
							<button type="submit" class="btn btn-primary">
								<i class="fas fa-magic"></i> Generate Projection
							</button>
							<button type="button" class="btn btn-outline-secondary" id="clear-btn">
								<i class="fas fa-refresh"></i> Reset
							</button>
						</div>
					</form>

					{% if closest_metro_name %}
					<div class="metro-info">
						<i class="fas fa-subway"></i>
						<div>
							<strong>Closest Metro:</strong><br />
							{{ closest_metro_name }}
						</div>
					</div>
					{% endif %}
				</div>

				<!-- Map Container (Location Second) -->
				<div class="map-container">
					<div class="map-header">
						<i class="fas fa-map-marker-alt"></i>
						<h5>Select Property Location</h5>
					</div>
					<div id="map"></div>
				</div>

				<!-- Chart Container (Output Last) -->
				<div class="chart-container">
					<div class="chart-header">
						<div class="chart-title">
							<i class="fas fa-chart-area"></i>
							<h5>3-Year Price Projection</h5>
						</div>
						<div class="chart-actions">
							<button
								class="btn btn-outline-secondary btn-sm"
								id="save-png-btn"
								style="display: none"
							>
								<i class="fas fa-download"></i> PNG
							</button>
							<button
								class="btn btn-outline-success btn-sm"
								id="save-excel-btn"
								style="display: none"
							>
								<i class="fas fa-file-excel"></i> Excel
							</button>
						</div>
					</div>

					<div class="chart-content">
						{% if projection_data and not projection_data.error %}
						<canvas id="projectionChart"></canvas>
						{% elif projection_data.error %}
						<div class="alert alert-danger">
							<i class="fas fa-exclamation-triangle"></i>
							{{ projection_data.error }}
						</div>
						{% else %}
						<div class="empty-state">
							<i class="fas fa-chart-line"></i>
							<h5>Ready to Generate Projection</h5>
							<p>Enter room details, select location, then generate</p>
						</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>

		<!-- Hidden form for Excel download -->
		<form
			id="excel-download-form"
			action="/download_excel"
			method="POST"
			style="display: none"
		>
			<input type="hidden" name="projection_data" id="excel-data-input" />
		</form>

		<!-- JS Libraries -->
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
		<script src="https://unpkg.com/leaflet-geosearch@3.11.0/dist/geosearch.umd.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

		<!-- Main Application Script -->
		<script>
			document.addEventListener("DOMContentLoaded", function () {
				const latInput = document.getElementById("latitude");
				const lonInput = document.getElementById("longitude");
				let lat = parseFloat(latInput.value);
				let lon = parseFloat(lonInput.value);

				// Initialize map
				const map = L.map("map").setView([lat, lon], 11);
				L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
					attribution:
						'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
				}).addTo(map);

				let marker = L.marker([lat, lon], { draggable: true })
					.addTo(map)
					.bindTooltip(`${lat.toFixed(4)}, ${lon.toFixed(4)}`, {
						permanent: true,
						direction: "top",
						offset: [0, -10],
					})
					.openTooltip();

				function updateMarkerAndTooltip(latlng) {
					latInput.value = latlng.lat.toFixed(6);
					lonInput.value = latlng.lng.toFixed(6);
					marker.setLatLng(latlng);
					marker.setTooltipContent(
						`${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`
					);
				}

				// Search control
				const search = new GeoSearch.GeoSearchControl({
					provider: new GeoSearch.OpenStreetMapProvider(),
					style: "bar",
					showMarker: false,
					autoClose: true,
				});
				map.addControl(search);

				// Event listeners
				map.on("geosearch/showlocation", (result) => {
					const latlng = L.latLng(result.location.y, result.location.x);
					updateMarkerAndTooltip(latlng);
					map.panTo(latlng);
				});

				marker.on("dragend", (e) => updateMarkerAndTooltip(e.target.getLatLng()));
				map.on("click", (e) => updateMarkerAndTooltip(e.latlng));

				document.getElementById("clear-btn").addEventListener("click", () => {
					window.location.href = "/";
				});

				// Resize map when container changes
				const resizeObserver = new ResizeObserver(() => {
					setTimeout(() => {
						map.invalidateSize();
					}, 100);
				});
				resizeObserver.observe(document.getElementById("map"));

				// Chart and Export Logic
				{% if projection_data and not projection_data.error %}
				const ctx = document.getElementById('projectionChart');
				const projectionData = {{ projection_data | tojson }};
				const savePngBtn = document.getElementById('save-png-btn');
				const saveExcelBtn = document.getElementById('save-excel-btn');

				const projectionChart = new Chart(ctx, {
					type: 'line',
					data: {
						labels: projectionData.labels,
						datasets: [{
							label: 'Projected Price (AED)',
							data: projectionData.values,
							borderColor: '#2563eb',
							backgroundColor: 'rgba(37, 99, 235, 0.1)',
							fill: true,
							tension: 0.4,
							borderWidth: 3,
							pointBackgroundColor: '#2563eb',
							pointBorderColor: '#ffffff',
							pointBorderWidth: 2,
							pointRadius: 6,
							pointHoverRadius: 8
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						plugins: {
							legend: {
								display: false
							}
						},
						scales: {
							y: {
								min: projectionData.y_min,
								max: projectionData.y_max,
								grid: {
									color: 'rgba(0, 0, 0, 0.05)'
								},
								ticks: {
									callback: (value) => 'AED ' + value.toLocaleString(),
									font: {
										size: window.innerWidth < 768 ? 10 : 12,
										weight: '600'
									}
								}
							},
							x: {
								grid: {
									color: 'rgba(0, 0, 0, 0.05)'
								},
								ticks: {
									font: {
										size: window.innerWidth < 768 ? 10 : 12,
										weight: '600'
									}
								}
							}
						}
					}
				});

				// Show export buttons
				savePngBtn.style.display = 'inline-flex';
				saveExcelBtn.style.display = 'inline-flex';

				// Export handlers
				savePngBtn.addEventListener('click', () => {
					const link = document.createElement('a');
					link.href = projectionChart.toBase64Image();
					link.download = 'price_projection.png';
					link.click();
				});

				saveExcelBtn.addEventListener('click', () => {
					document.getElementById('excel-data-input').value = JSON.stringify(projectionData);
					document.getElementById('excel-download-form').submit();
				});

				// Handle window resize for chart
				window.addEventListener('resize', () => {
					projectionChart.resize();
				});
				{% endif %}
			});
		</script>
	</body>
</html>